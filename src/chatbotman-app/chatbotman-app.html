<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="myicons.html">

<dom-module id="chatbotman-app">
    <template>
        <style>
            :host {
                display: block;
            }

            iron-image {
                width: 100%;
                height: 80vh;
            }

            paper-fab.record {
                position: fixed;
                right: 32px;
                bottom: 64px;
                color: #999999;
                --paper-fab-background: #FFFFFF;
                --paper-fab-keyboard-focus-background: #EEEEEE;
            }

            paper-fab.recording {
                color: var(--paper-red-500);
            }
        </style>
        <h2>Let's talk!</h2>
        <iron-image sizing="contain" alt="Cat" src="../../images/neko_punch.png"></iron-image>
        <paper-fab id="mic" icon="myicons:mic" title="record" class="record" on-tap="handleMicTap"></paper-fab>
    </template>

    <script>
        /**
         * @customElement
         * @polymer
         */
        class ChatbotmanApp extends Polymer.Element {

            static get is() {
                return 'chatbotman-app';
            }

            constructor() {
                super();
                let parser = new URL(location.href);
                this.host = parser.searchParams.has('host') ? parser.searchParams.get('host') : '180.54.60.193:8080';

                let self = this;
                this.recognition = new webkitSpeechRecognition();
                this.recognition.lang = 'ja';
                this.recognition.addEventListener('result', e => {
                    self.$.mic.classList.remove('recording');
                    let xhr = new XMLHttpRequest();
                    xhr.onload = function(){
                        self.say(xhr.responseText);
                    };
                    xhr.open('GET', 'http://' + self.host + '/talk?q=' + encodeURIComponent(e.results[0][0].transcript));
                    xhr.send();
                });
            }

            handleMicTap(event) {
                if (event.target.classList.contains('recording')) {
                    event.target.classList.remove('recording');
                    this.recognition.abort();
                } else {
                    event.target.classList.add('recording');
                    this.recognition.start();
                }
            }

            say(text, lang = 'ja-JP') {
                let utterance = new SpeechSynthesisUtterance();
                utterance.text = text;
                utterance.lang = lang;
                speechSynthesis.speak(utterance);
            }
        }

        window.customElements.define(ChatbotmanApp.is, ChatbotmanApp);
    </script>
</dom-module>
